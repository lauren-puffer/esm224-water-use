---
title: "Feather River Water Use"
author: "Lauren Puffer"
format: html
editor: visual
---

## Load packages

```{r}
library(tidyverse)
library(janitor)
library(here)
library(DT)
library(stringr)
```

## Data source

## Population data

Use values for self supplied ground and surface water for Plumas and Butte county.

```{r}
# read in population data csv
water_use <- read.csv(here("data", "MF_WaterUse_Butte_Plumas_Sierra_raw.csv"))

# look at the data
summary(water_use)
```

## Data cleaning

Select for columns with self-supplied surface water and self-supplied groundwater.

```{r}
# filter for county
water_use_clean <- water_use |>
  select(County.Name,  Public.Supply.total.self.supplied.withdrawals..surface.water..in.Mgal.d., 
          Public.Supply.total.self.supplied.withdrawals..groundwater..in.Mgal.d.) |>
  clean_names() 

# get summary of names
summary(water_use_clean)

# rename titles of columns
water_use_clean <- rename(water_use_clean, public_self_surface = public_supply_total_self_supplied_withdrawals_surface_water_in_mgal_d, 
          public_self_groundwater =  public_supply_total_self_supplied_withdrawals_groundwater_in_mgal_d,
          county = county_name)

# pivot the dataset longer
water_use_long <- water_use_clean |>
  pivot_longer(
    cols = c(public_self_surface, public_self_groundwater),
    names_to = "water_source",
    values_to = "mgal_day")

```

## Data visualization

```{r}
# make bar graph of groundwater and surface water stacked and separated by county
gw_sw_bar <-ggplot(water_use_long, aes(x = county, y = mgal_day, fill = water_source)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Public Self-Supplied Water Withdrawals by County",
    x = "County",
    y = "Million Gallons per Day (Mgal/d)",
    fill = "Water Source"
  ) +
  scale_fill_manual(
  values = c("public_self_surface" = "#1f77b4", 
             "public_self_groundwater" = "#2ca02c"),
  labels = c("public_self_surface" = "Surface Water",
             "public_self_groundwater" = "Ground Water"))+
  theme_minimal() +
    theme(axis.text.x = element_text(hjust = 1),
          plot.background = element_rect(fill = "white", color = NA)) +
  theme(axis.text.x = element_text(hjust = 1))

print(gw_sw_bar)
```

Save the bar graph!

```{r}
ggsave(filename = here("plots", "public_withdrawl.png"),
  plot = gw_sw_bar,
  width = 10,
  height = 6,
  dpi = 300)
```

# Diverse water uses by county

We need to bring back some of the categories that we previously got rid of. We will do this by bringing in the raw "water_use" file.

## Data cleaning

```{r}
# clean names so categories are easier to read
water_use_industry <- water_use |>
  clean_names() 

# select for only the categories of self supply by industry
water_use_industry <- water_use_industry |>
  select(county_name, 
         # public
         public_supply_total_self_supplied_withdrawals_surface_water_in_mgal_d,
         public_supply_total_self_supplied_withdrawals_groundwater_in_mgal_d,
         
         # domestic
         domestic_self_supplied_groundwater_withdrawals_fresh_in_mgal_d, 
         domestic_self_supplied_surface_water_withdrawals_fresh_in_mgal_d,
         
         # industrial
         industrial_self_supplied_groundwater_withdrawals_fresh_in_mgal_d,
         industrial_self_supplied_surface_water_withdrawals_fresh_in_mgal_d,
         
         # mining
         mining_self_supplied_groundwater_withdrawals_fresh_in_mgal_d,
         mining_self_supplied_surface_water_withdrawals_fresh_in_mgal_d,
         
         # livestock
         livestock_self_supplied_groundwater_withdrawals_fresh_in_mgal_d,
         livestock_self_supplied_surface_water_withdrawals_fresh_in_mgal_d,
         
         # aquaculture
         aquaculture_self_supplied_groundwater_withdrawals_fresh_in_mgal_d,
         aquaculture_self_supplied_surface_water_withdrawals_fresh_in_mgal_d,
         
         # crop irrigation
         irrigation_crop_self_supplied_groundwater_withdrawals_for_crops_fresh_in_mgal_d,
         irrigation_crop_self_supplied_surface_water_withdrawals_for_crops_fresh_in_mgal_d,
         
         # golf irrigation
         irrigation_golf_courses_self_supplied_groundwater_withdrawals_for_golf_courses_fresh_in_mgal_d,
         irrigation_golf_courses_self_supplied_surface_water_withdrawals_for_golf_courses_fresh_in_mgal_d)
```

Soo many names! Shorten the column titles.

```{r}
# create dataset with shorter column names
water_use_industry <- rename(water_use_industry, 
                             domestic_ground = domestic_self_supplied_groundwater_withdrawals_fresh_in_mgal_d, 
                             domestic_surface = domestic_self_supplied_surface_water_withdrawals_fresh_in_mgal_d, 
                             industrial_ground = industrial_self_supplied_groundwater_withdrawals_fresh_in_mgal_d, 
                             industrial_surface = 
industrial_self_supplied_surface_water_withdrawals_fresh_in_mgal_d, 
                             mining_ground =
mining_self_supplied_groundwater_withdrawals_fresh_in_mgal_d, 
                             mining_surface =
mining_self_supplied_surface_water_withdrawals_fresh_in_mgal_d,
                             livestock_ground = 
livestock_self_supplied_groundwater_withdrawals_fresh_in_mgal_d, 
                             livestock_surface = 
livestock_self_supplied_surface_water_withdrawals_fresh_in_mgal_d,
                             aquaculture_ground =
aquaculture_self_supplied_groundwater_withdrawals_fresh_in_mgal_d,
                            aquaculture_surface =
aquaculture_self_supplied_surface_water_withdrawals_fresh_in_mgal_d,
                            crop_ground =
irrigation_crop_self_supplied_groundwater_withdrawals_for_crops_fresh_in_mgal_d,
                            crop_surface =
irrigation_crop_self_supplied_surface_water_withdrawals_for_crops_fresh_in_mgal_d,
                            golf_ground =
irrigation_golf_courses_self_supplied_groundwater_withdrawals_for_golf_courses_fresh_in_mgal_d,
                            golf_surface =
irrigation_golf_courses_self_supplied_surface_water_withdrawals_for_golf_courses_fresh_in_mgal_d, 
                            pubic_surface =
public_supply_total_self_supplied_withdrawals_surface_water_in_mgal_d,
                            public_ground =
         public_supply_total_self_supplied_withdrawals_groundwater_in_mgal_d)

# make a column with the sum of all water used for each county
water_use_industry$total_water_use <- rowSums(water_use_industry[sapply(water_use_industry, is.numeric)])

# get total ground and total surface

# Identify columns with "groundwater" in their name
gw_cols <- names(water_use_industry)[str_detect(names(water_use_industry), "ground")]

# Create a new column that sums them
water_use_industry$total_groundwater <- rowSums(water_use_industry[, gw_cols])

# Identify columns with "surface_water" in their name
gw_cols_surf <- names(water_use_industry)[str_detect(names(water_use_industry), "surface")]

# Create a new column that sums them
water_use_industry$total_surface_water <- rowSums(water_use_industry[, gw_cols_surf])
```

Pivot longer to create one column fo industry and one column for ground/surface water.

```{r}
# load stringr to use str_detect to separate by "_"
library(stringr)

# use pivot_longer() and str_extract() to improve dataset
water_use_long <- water_use_industry |>
  pivot_longer(
    cols = ends_with(c("_ground", "_surface")),  # or simply everything except County if thatâ€™s the ID
    names_to = "category",
    values_to = "mgal_day"
  ) |>
  mutate(
    # separate "category" like "industrial_ground" into two pieces:
    use = str_extract(category, "^[^_]+"),       # everything before first "_"
    source = str_extract(category, "(?<=_)\\w+$") # everything after last "_"
  ) |>
  select(-category)

# alter dataset to only have totals by ground and surface
county_source_totals <- water_use_long |>
  group_by(county_name, source) |>
  summarise(total_mgal = sum(mgal_day, na.rm = TRUE), .groups = "drop") |>
  pivot_wider(
    names_from = source,
    values_from = total_mgal,
    names_prefix = "total_"
  )
```

We are going to save this data set for future use.

```{r}
# save dataset
write.csv(water_use_long, here("data", "water_by_use.csv"))
```

## Make bar graph of water use by county

```{r}
# load cowplot for stacked visualizations
library(patchwork)

# consistent color palette
colors <- c("pct_ground" = "#2ca02c",  # green
            "pct_surface" = "#1f77b4") # blue

# create dataset for percentage plot
plot_data <- county_source_totals |>
  group_by(county_name) |>
  mutate(pct_ground = total_ground / (total_ground+total_surface) * 100) |>
  mutate(pct_surface = total_surface / (total_ground+total_surface)*100)|>
  ungroup()

```

## Plot percentages for ground and surface water

```{r}
# pivot longer AGAIN
plot_data <- plot_data |>
  pivot_longer(
    cols = c(pct_ground, pct_surface),
    names_to = "source",
    values_to = "pct"
  )
# use plot_data df for geom_col()
water_use_plot <- ggplot(plot_data, aes(x = county_name, y = pct, fill = source)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_manual(values = colors)+
  labs(
    x = "County",
    y = "Percentage of Total Withdrawals",
    fill = "Water Source",
    title = "Groundwater vs Surface Water Percentage by County"
  ) +
  theme_minimal()
```

```{r}
# save plot
ggsave(filename = here("plots", "withdrawl_by_county.png"),
  plot = water_use_plot,
  width = 10,
  height = 6,
  dpi = 300)
```

## Create dataset with totals

```{r}
# get names of columns
names(water_use_industry)
# select for groundwater, surface water, and totals in dataset
# pivot the dataset longer
water_use_long_industry <- water_use_industry |>
  pivot_longer(
    cols = c(, public_self_groundwater),
    names_to = "water_source",
    values_to = "mgal_day")
```
