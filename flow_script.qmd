---
title: "Flow Gauge Analysis"
author: "Lauren Puffer"
format: html
editor: visual
---

## Load packages

```{r}
library(here)
library(tidyverse)
library(janitor)
library(tmap)
library(terra)
library(tigris)
library(here)
library(sf)
library(stars)
library(dplyr)
library(kableExtra)
library(ggplot2)
```

## Load data

Data comes from 3 locations throughout the watershed.

```{r}
# load data from strawberry station
strawb_flow <- read.csv(here("data", "flow_gauges", "SF FEATHER R BL DIV DAM NR STRA.csv"))|>
  clean_names()

# load data from forbestown station
forbes_flow <- read.csv(here("data", "flow_gauges", "SF FEATHER R BL FORBESTOWN DAM.csv"))|>
  clean_names()

# load data from little grass valley station
grass_flow <- read.csv(here("data", "flow_gauges", "SF FEATHER R BL LITTLE GRASS VA.csv"))|>
  clean_names()
```

## Data cleaning

```{r}
# load lubridate
library(lubridate)

# Structure
# df$date <- mdy_hm(df$date)

# use lubridate to fix the dates in strawb_flow
strawb_flow$date <- mdy_hm(strawb_flow$date) # starts at 2001?

# use lubridate to fix the dates in forbes_flow
forbes_flow$date <- mdy_hm(forbes_flow$date)

# use lubridate to fix the dates in grass_flow
grass_flow$date <- mdy_hm(grass_flow$date)
```

Now we can get flows (discharge_m3_s) over time (date).

## Plot discharge over time

We will have to do this for each station. Then we will use patchwork to display them all at once. This will likely be a line graph!

```{r}
# load patchwork
library(patchwork)

# create line graph for strawb station
strawb_plot <- ggplot(strawb_flow, aes(x = date, y = discharge_m3_s)) +
  geom_line(color = "steelblue", linewidth = 1) +
  labs(
    title = "Flows near Strawberry Valley, CA",
    x = " ",
    y = expression(" ")
  ) +
  scale_x_datetime(date_labels = "%Y", date_breaks = "2 years")+
  theme_minimal()

# create line graph for forbes station
forbes_plot <- ggplot(forbes_flow, aes(x = date, y = dsicharge_m3_s)) +
  geom_line(color = "steelblue", linewidth = 1) +
  labs(
    title = "Flows near Forbestown, CA",
    x = " ",
    y = expression("Discharge (m"^3*"/s)")
  ) +
  scale_x_datetime(date_labels = "%Y", date_breaks = "2 years")+
  theme_minimal()

# create line graph for little grass valley station
grass_plot <- ggplot(grass_flow, aes(x = date, y = dishcarge_m3_s)) +
  geom_line(color = "steelblue", linewidth = 1) +
  labs(
    title = "Flows near Grass Valley, CA",
    x = "Year",
    y = expression(" ")
  ) +
    scale_x_datetime(date_labels = "%Y", date_breaks = "2 years")+
  theme_minimal()

# plot graphs together
discharge_plot <- strawb_plot/forbes_plot/grass_plot
```

Save the plot

```{r}
# save patchwork plot
ggsave(filename = here("plots", "discharge_by_station.png"),
  plot = discharge_plot,
  width = 10,
  height = 6,
  dpi = 300)
```

## Create a table of gauge stations

We will create our own dataset with information about the flow gauges.

```{r}
# create a data frame manually with site name, site id, and period of record
flow_station_df <- data.frame(
  site_id = c("11395200", "11396200", "11395030"),
  site_name = c("South Fork Feather River Below Diversion Dam Near Strawberry Valley CA ",
                "South Fork Feather River Below Forbestown Dam", "South Fork Feather River Below Little Grass Valley"),
  period_of_record = c("1961–present", "1961–present", "1961–present"),
  stringsAsFactors = FALSE
)

# View the dataframe
print(flow_station_df)
```

Create a table of flow gauge stations and period of record.

```{r}
# Load required packages
library(knitr)
library(kableExtra)

# Create a styled table
flow_station_df %>%
  kable(
    col.names = c("Site ID", "Site Name", "Period of Record"),
    caption = "Flow Gauge Stations"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14
  ) %>%
  row_spec(0, extra_css = "font-family: 'EB Garamond', serif;") %>%
  row_spec(1:3, extra_css = "font-family: 'EB Garamond', serif;")

```

Now, we want to get the means, mins and max's of our flow station data by station.

```{r}
# make sure discharge is numeric
strawb_flow |>
  mutate(discharge_m3_s = as.numeric(discharge_m3_s))

forbes_flow <- forbes_flow |>
  mutate(discharge_m3_s = as.numeric(dsicharge_m3_s))

grass_flow <- grass_flow |>
  mutate(discharge_m3_s = as.numeric(dishcarge_m3_s))

# get flow means
mean_strawb <- mean(strawb_flow$discharge_m3_s)
mean_forbes <- mean(forbes_flow$discharge_m3_s)
mean_grass <- mean(grass_flow$discharge_m3_s)

# get the mins
min_strawb <- min(strawb_flow$discharge_m3_s)
min_forbes <- min(forbes_flow$discharge_m3_s)
min_grass <- min(grass_flow$discharge_m3_s)


# get the max
max_strawb <- max(strawb_flow$discharge_m3_s)
max_forbes <- max(forbes_flow$discharge_m3_s)
max_grass <- max(grass_flow$discharge_m3_s)
```

Make a summary dataframe.

```{r}
# make a summary of all mean, min, and max
# Combine your summary statistics into a data frame
flow_summary <- data.frame(
  site_name = c("South Fork Feather River Below Diversion Dam Near Strawberry Valley CA ",
                "South Fork Feather River Below Forbestown Dam", "South Fork Feather River Below Little Grass Valley"),
  mean_flow_m3_s = c(mean_strawb, mean_forbes, mean_grass),
  min_flow_m3_s = c(min_strawb, min_forbes, min_grass),
  max_flow_m3_s = c(max_strawb, max_forbes, max_grass)
)
```

Now we can make the table.

```{r}
# Create a nicely formatted table
flow_summary %>%
  kable(
    col.names = c("Site Name", "Mean Flow (m³/s)", "Min Flow (m³/s)", "Max Flow (m³/s)"),
    caption = "Summary of Flow Statistics by Site"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14
  ) %>%
  row_spec(0, extra_css = "font-family: 'EB Garamond', serif;") %>%
  row_spec(1:nrow(flow_summary), extra_css = "font-family: 'EB Garamond', serif;")

```

## Flow gauge location

```{r}
# add latitude and longitude to flow_station_df
flow_station_df$latitude <- c(39.6475,39.5514, 39.7239 )

flow_station_df$longitude <- c(-121.1178, -121.2083,-121.0211 )
```

Change these points to geometries.

```{r}
# make geometries from lat and longs
df_sf <- st_as_sf(flow_station_df, coords = c("longitude", "latitude"), crs = 4267) # NAD 27 used in USGS flow station data

# get base map of california
library(tigris)

# get 'california' from tigris
# Load California county boundaries with the state's shapefile
ca_counties <- counties(cb = TRUE, state = "CA") |>
  st_transform(crs = 4267) # project to NAD 27

# filter for counties in watershed
watershed_counties <- ca_counties |>
  filter(NAME %in% c("Butte", "Plumas", "Sierra", "Lassen", "Yuba"))

# plot counties and flow stations
library(tmap)

flow_gauge_map <- tm_shape(watershed_counties)+
  tm_polygons() +
  tm_shape(df_sf)+
  tm_dots(fill = "red")
```

Get map of HUC 8.

```{r}
# bring in shape file of HUC 18020123
hucs <- st_read(here("watershed_shape","cat.shp"))

# check crs of points
st_crs(df_sf) # 4267

# check crs of watershed shape file
st_crs(hucs) # NA

# hucs are in 4269
st_crs(hucs) <- 6318

# check that they match
st_crs(df_sf_proj) == st_crs(hucs)

# transform to match the crs of counties
hucs_proj <- st_transform(hucs, st_crs(watershed_counties))
df_sf_proj <- st_transform(df_sf, st_crs(watershed_counties))



# filter for our HUC
huc_18020123 <- hucs_proj |>
  filter(HUC8 == "18020123")
```

Get a map of the watershed and flow gauge stations.

```{r}
# make mape of flow stations
flow_map <- tm_shape(huc_18020123) +
  tm_polygons(fill = "lightblue") +
  tm_shape(df_sf_proj) +
  tm_dots(col = "red", size = 0.2)

flow_map
```

Export csv

```{r}
# write csv
write.csv(flow_station_df, here("data", "flow_stations.csv"))
```

# Point sources

Load data

```{r}
# read in point source data
pt_source <- read.csv(here("data", "PCS_data_MF.csv")) |>
  clean_names()

# make geometries out of data frame
points_sf <- st_as_sf(pt_source,
                      coords = c("facility_latitude", "facility_longitude"),
                      crs = 4326) # WGS 84 (degrees)

# bring in shape file of watershed
hucs <- st_read(here("watershed_shape","cat.shp"))
st_crs(hucs) <- 26910 # UTM Zone 10


# filter for our HUC
huc_18020123 <- hucs |>
  filter(HUC8 == "18020123")

# transform to fit points
points_proj <- st_transform(points_sf, 26910)

# plot points 
plot(st_geometry(points_proj), col = "red", pch = 20)


# check that CRSs match
st_crs(points_proj) == st_crs(huc_18020123)
```

## Troubleshooting

```{r}
# check bbox
st_bbox(huc_18020123)
st_bbox(points_proj)

# see 
```

## Plot point sources

Now we can attempt to plot these two on top of eachother (watershed boundary and point sources).

```{r}
tmap_mode("plot")


tm_shape(huc_18020123) +
  tm_polygons() +
  tm_shape(points_proj) +
  tm_dots(fill = "red", size = 0.5)

# try plotting just the points
plot(st_geometry(points_proj), add = TRUE, col = "red", pch = 20)

```

## Dataframe of point sources

Get names of unique sources and the number of pollutants belonging to each one's permit.

```{r}

# data frame of pollutant count by permit holder
df_pollutant_counts <- pt_source |>
  group_by(facility_name) |>
  summarise(n_unique_pollutants = n_distinct(pollutant_name))

# data frame of pollutant name by permit holder
df_combined <- pt_source |>
  group_by(facility_name) |>
  summarise(pollutant_name = paste(unique(pollutant_name), collapse = ", "))

# join datasets
pollutant_join <- left_join(df_pollutant_counts, df_combined, by = "facility_name")

library(kableExtra)

# make a table using kable
kable(
  pollutant_join,
  format = "html",
  caption = "Number of Pollutants by Permit",
  col.names = c("Name of Facility", "# of Pollutants on Permit", "Pollutants"), # Custom column names
  align = c("c"), # Left, Center, Right alignment for columns
  row.names = FALSE # Hide row names
)

# Create a styled table
pollutant_join |>
  kable(
    col.names = c("Name of Facility", "Number of Pollutants", "Pollutant Name"),
    caption = "Pollutants by permit",
      align = "l" # Left, Center, Right alignment for columns
  ) |>
  kable_styling(
    bootstrap_options = "striped",
    full_width = FALSE,
    font_size = 14
  ) |>
  row_spec(0, extra_css = "font-family: 'EB Garamond', serif;") |>
  row_spec(1:2, extra_css = "font-family: 'EB Garamond', serif;")
```

Get graph of contaminant concentrations per point source.

```{r}
# df for delleker
delleker_pt_source <- pt_source |>
  filter(facility_name == "DELLEKER WWTP")|>
  mutate(average_daily_flow_mgd = as.numeric(average_daily_flow_mgd))

# df for portala
portola_pt_source <- pt_source |>
  filter(facility_name == "PORTOLA WWTP") |>
  mutate(average_daily_flow_mgd = as.numeric(average_daily_flow_mgd))




# graph of annual pounds of pollutants from Delleker
delleker_discharge <- ggplot(delleker_pt_source, 
                             aes(x = pollutant_name, 
                                 y = total_pounds_lb_yr)) +
  geom_col(fill = "steelblue") +
  labs(
    title = "Annual Pounds of Contaminant (lbs/yr) - Delleker WWTP",
    x = "Pollutant",
    y = "Total Pounds (2025)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



# graph of annual pounds of pollutants from Portola
portola_discharge <- ggplot(portola_pt_source, 
                             aes(x = pollutant_name, 
                                 y = total_pounds_lb_yr)) +
  geom_col(fill = "steelblue") +
  labs(
    title = "Annual Pounds of Contaminant (lbs/yr) - Portola WWTP",
    x = "Pollutant",
    y = "Total Pounds (2025)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Save both plots!

```{r}
# save the Delleker plot
ggsave(here("plots", "delleker_discharge.png"), delleker_discharge, 
       width = 7, height = 5, bg = "white")

# save the Portola plot
ggsave(here("plots", "porotla_discharge.png"), portola_discharge, 
       width = 7, height = 5, bg = "white")
```

Make a table with the pollutants belonging to each permit holder.

```{r}
df_combined <- pt_source |>
  group_by(facility_name) |>
  summarise(pollutant_name = paste(unique(pollutant_name), collapse = ", "))

```

Discrecpancy about the fact the the facility may not release a pollutant even though it is listed on the permit. This is because permits must be conservative and are deisgned prior to facility operations. Any contaminant that could reasonably be created from a facility should be on the permit.

# Stormwater analysis

We have to bring in the precipitation data and categorize it by precipitation in inches. This allows us to examine how many storms occurred over a 10 year period and the severity of those storms. The following categories are storm events, storm events \> 1 inch, storm events \> 2 inch, and storm events \> 4 inches. We will use 2 weather stations for this analysis (Near Oroville and near Portola)

## Table of storm severity

```{r}
# Bring in precipitation data
oroville_weather <- read.csv(here("data", "oroville_weather.csv")) |>
  clean_names()
portola_weather <- read.csv(here("data", "portola_weather.csv"))|>
  clean_names()

# Get date in proper format using lubridate 
oroville_weather$date <- mdy(oroville_weather$date)
portola_weather$date <- mdy(portola_weather$date)

# Get dataset with a column for category of storm
oroville_weather$storm <- cut(
  oroville_weather$prcp,
  breaks = c(-Inf, 1, 2, 4, Inf),
  labels = c("≤1 inch", ">1 inch", ">2 inches", ">4 inches"),
  right = TRUE
)

portola_weather$storm <- cut(
  portola_weather$prcp,
  breaks = c(-Inf, 1, 2, 4, Inf),
  labels = c("≤1 inch", ">1 inch", ">2 inches", ">4 inches"),
  right = TRUE
)

# Keep only observations between 2015-10-15 and 2024-09-30 at Portola
portola_weather <- portola_weather |>
  filter(date >= as.Date("2015-10-15") &
         date <= as.Date("2024-09-30"))

# Keep only observations between 2015-10-15 and 2024-09-30 at Oroville
oroville_weather <- oroville_weather |>
  filter(date >= as.Date("2015-10-15") &
         date <= as.Date("2024-09-30"))
```

Create a table with percentage of storms from each category and number of storms.

```{r}
# Combine the two datasets
combined_storms <- bind_rows(
  portola_weather |>
    mutate(site = "Portola"),
  oroville_weather |>
    mutate(site = "Oroville"))

# Get a dataset that has the number of each storm
storm_summary <- combined_storms |>
  count(site, storm, name = "count") |>
  group_by(site) |>
  mutate(percent = round(100 * count / sum(count), 1))

kable(storm_summary,
      caption = "Storm Categories at Portola and Oroville",
      col.names = c("Site", "Storm Category", "Count", "Percent of Total")) |>
  kable_styling(
    full_width = TRUE,
    bootstrap_options = c("striped")
  )

```

Since the two sites are so similar, lets create a table just for one of the sites to represent the precipitation of the entire watershed.

```{r}
# Get summary of storms at Portola station
portola_storm_summary <- portola_weather |>
  count(storm, name = "count") |>
  mutate(percent = round(100 * count / sum(count), 1))

# Make table of storm category
kable(portola_storm_summary, caption = "Frequency of Storms from 2015-2024",
      col.names = c("Storm Category", "Count", "Percent of Total")) |>
  kable_classic(full_width = TRUE) |>
    kable_styling(
    full_width = TRUE,
    bootstrap_options = c("striped")
  )
```

Now we have to bring in data for stormwater flows. We will use 1 downstream gauge station for this analysis.

```{r}
# Read in flow gauge data
strawb_flow <- read.csv(here("data", "flow_gauges", "SF FEATHER R BL DIV DAM NR STRA.csv"))|>
  clean_names()

# Use lubridate to clean date column
strawb_flow$date <- mdy_hm(strawb_flow$date)

# Keep only observations between 2015-10-15 and 2024-09-30
strawb_flow <- strawb_flow |>
  filter(date >= as.Date("2015-10-15") &
         date <= as.Date("2024-09-30"))
```

Now to parse the data out, we will get monthly values of precipitation and flow.

```{r}
# portola_weather has a PRCP column in inches and a date column
portola_monthly <- portola_weather |>
  mutate(month = floor_date(date, "month")) |>
  group_by(month) |>
  summarize(monthly_prcp = sum(prcp, na.rm = TRUE))

# Monthly discharge (mean)
strawb_monthly <- strawb_flow |>
  mutate(month = floor_date(date, "month")) |>
  group_by(month) |>
  summarize(monthly_discharge = mean(discharge_ft3_s, na.rm = TRUE))
```

Join the two datasets so that you can plot using one dataset.

```{r}
# Join discharge with precipitation
plot_df <- strawb_monthly |>
  left_join(portola_monthly, by = "month")
```

Plot the data from the joined dataset.

```{r}
# Create a scale factor
range_flow <- range(plot_df$monthly_discharge, na.rm = TRUE)
range_prcp <- range(plot_df$monthly_prcp, na.rm = TRUE)

k <- max(range_flow) / max(range_prcp)   

# Plot mean monthly discharge over total monthly rainfall
hydrograph <- ggplot(plot_df, aes(x = month)) +

  # Precip bars
  geom_col(
    aes(y = monthly_prcp * k, fill = "Precipitation"),
    alpha = 1
  ) +

  # Discharge line
  geom_line(
    aes(y = monthly_discharge, color = "Discharge"),
    linewidth = 1
  ) +

  # Legends for color and fill
  scale_color_manual(
    name = "Legend",
    values = c("Discharge" = "#2A788EFF")
  ) +
  scale_fill_manual(
    name = "Legend",
    values = c("Precipitation" = "#7AD151FF")
  ) +

  # Axes
  scale_y_continuous(
    name = "Mean Monthly Discharge (ft³/s)",
    sec.axis = sec_axis(~ . / k, name = "Monthly Precipitation (inches)")
  ) +

  # Labels & theme
  labs(
    title = "Mean Discharge and Total Precipitaion per Month",
       x = "Month"  
    ) +
  theme_bw() +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 11)
  )


# Save the graph
ggsave(filename = here("plots", "hydrograph.png"),
  plot = hydrograph,
  width = 10,
  height = 6,
  dpi = 300)
```
